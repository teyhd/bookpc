<div class="space-y-6">
  <div class="glass-panel rounded-2xl border border-border/80 p-6 shadow-glow">
    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <p class="text-xs uppercase tracking-[0.2em] text-slate-400">сеть</p>
        <h4 class="text-2xl font-semibold text-slate-50">Мониторинг устройств</h4>
        <p class="text-sm text-slate-400">Обновили палитру под Platoniks: глубокий фон, акцентные голубые, минимум шума.</p>
      </div>
      <button class="inline-flex items-center gap-2 rounded-lg border border-border/80 px-4 py-2 text-sm text-slate-100 transition hover:border-brand hover:bg-brand/10" id="exportCSV">
        <span class="material-icons text-base">file_download</span> Экспорт CSV
      </button>
    </div>

    <div class="mt-6 grid gap-4 lg:grid-cols-3">
      <div class="rounded-xl border border-border/70 bg-[#0b1120]/60 p-4 lg:col-span-2">
        <div class="flex flex-wrap items-center justify-between gap-2">
          <h5 class="text-lg font-semibold text-slate-50">Активность</h5>
          <div class="flex flex-wrap gap-2 time-filter">
            <button class="rounded-lg border border-border/70 px-3 py-1 text-xs font-semibold text-slate-200 transition hover:border-brand hover:text-white" data-range="1h">1ч</button>
            <button class="rounded-lg border border-border/70 px-3 py-1 text-xs font-semibold text-slate-200 transition hover:border-brand hover:text-white" data-range="6h">6ч</button>
            <button class="rounded-lg border border-border/70 px-3 py-1 text-xs font-semibold text-slate-200 transition hover:border-brand hover:text-white" data-range="12h">12ч</button>
            <button class="rounded-lg border border-border/70 bg-white/5 px-3 py-1 text-xs font-semibold text-white" data-range="24h">24ч</button>
            <button class="rounded-lg border border-border/70 px-3 py-1 text-xs font-semibold text-slate-200 transition hover:border-brand hover:text-white" data-range="7d">7д</button>
            <button class="rounded-lg border border-border/70 px-3 py-1 text-xs font-semibold text-slate-200 transition hover:border-brand hover:text-white" data-range="30d">30д</button>
          </div>
        </div>
        <div class="mt-4 h-72">
          <canvas id="activityChart"></canvas>
        </div>
      </div>

      <div class="rounded-xl border border-border/70 bg-[#0b1120]/60 p-4">
        <div class="flex items-start justify-between">
          <div>
            <h5 class="text-lg font-semibold text-slate-50">Состояние сети</h5>
            <p class="text-sm text-slate-400">Подключения в реальном времени.</p>
          </div>
          <span class="metric-badge rounded-full border border-brand/50 bg-brand/10 px-3 py-1 text-xs font-semibold text-brand">—</span>
        </div>
        <div class="mt-4 h-48">
          <canvas id="connectionChart"></canvas>
        </div>
        <ul class="mt-4 space-y-1 text-sm text-slate-300">
          <li id="total-devices" class="flex items-center justify-between rounded-lg border border-border/60 bg-white/5 px-3 py-2">
            <span>Всего</span><span>0</span>
          </li>
          <li id="connected-devices" class="flex items-center justify-between rounded-lg border border-emerald-400/30 bg-emerald-500/10 px-3 py-2 text-emerald-100">
            <span>В сети</span><span>0</span>
          </li>
          <li id="disconnected-devices" class="flex items-center justify-between rounded-lg border border-rose-400/30 bg-rose-500/10 px-3 py-2 text-rose-100">
            <span>Недоступны</span><span>0</span>
          </li>
          <li id="last-update" class="flex items-center justify-between rounded-lg border border-border/60 bg-white/5 px-3 py-2">
            <span>Обновлено</span><span>—</span>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <div class="glass-panel rounded-2xl border border-border/80 p-6 shadow-glow">
    <div class="grid gap-4 md:grid-cols-3">
      <div class="md:col-span-1">
        <label for="search" class="text-sm text-slate-300">Поиск</label>
        <input type="text" id="search" placeholder="Имя, IP, MAC..." class="mt-2 w-full rounded-lg border border-border/80 bg-[#0b1120] px-3 py-2 text-slate-50 placeholder:text-slate-500 focus:border-brand focus:ring-1 focus:ring-brand/60">
      </div>
      <div class="md:col-span-1">
        <label for="sort-options" class="text-sm text-slate-300">Сортировка</label>
        <select id="sort-options" class="mt-2 w-full rounded-lg border border-border/80 bg-[#0b1120] px-3 py-2 text-slate-50 focus:border-brand focus:ring-1 focus:ring-brand/60">
          <option value="name" selected>По имени</option>
          <option value="ip">По IP</option>
          <option value="last_seen">По активности</option>
          <option value="mac">По MAC</option>
          <option value="vendor">По производителю</option>
        </select>
      </div>
      <div class="md:col-span-1 flex items-end gap-2">
        <button id="toggle-order" class="inline-flex w-full items-center justify-center rounded-lg border border-border/80 bg-white/5 px-3 py-2 text-sm text-slate-100 transition hover:border-brand hover:bg-brand/10">
          Сортировать: по возрастанию
        </button>
        <button id="refresh-data" class="inline-flex h-[42px] items-center justify-center rounded-lg border border-border/80 bg-brand/10 px-3 text-sm font-semibold text-brand shadow-glow transition hover:bg-brand/20">
          Обновить
        </button>
      </div>
    </div>
    <div class="mt-4 flex flex-wrap gap-3 filter-bar">
      <label class="inline-flex items-center gap-2 text-sm text-slate-300">
        <input name="device_filter" type="radio" value="all" checked class="h-4 w-4 rounded border-border/70 bg-[#0b1120] text-brand focus:ring-brand/60">
        <span>Все</span>
      </label>
      <label class="inline-flex items-center gap-2 text-sm text-slate-300">
        <input name="device_filter" type="radio" value="connected" class="h-4 w-4 rounded border-border/70 bg-[#0b1120] text-brand focus:ring-brand/60">
        <span>В сети</span>
      </label>
      <label class="inline-flex items-center gap-2 text-sm text-slate-300">
        <input name="device_filter" type="radio" value="disconnected" class="h-4 w-4 rounded border-border/70 bg-[#0b1120] text-brand focus:ring-brand/60">
        <span>Недоступны</span>
      </label>
    </div>
  </div>

  <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-3" id="devices-list">
    {{#each devices}}
      <div class="device-card glass-panel rounded-2xl border border-border/80 p-4 shadow-glow"
           data-device='{{{json this}}}'
           data-name="{{name}}"
           data-ip="{{ip}}"
           data-last_seen="{{last_seen}}"
           data-mac="{{mac}}"
           data-vendor="{{vendor}}"
           data-connected="{{connected}}">
        <div class="flex items-start justify-between gap-3">
          <div>
            <p class="text-sm font-semibold text-slate-50">{{name}}</p>
            <p class="text-xs text-slate-400">Обновлено: {{formatDate last_seen}}</p>
          </div>
          <span id="connected_{{id}}" class="rounded-full px-3 py-1 text-xs font-semibold {{#if connected}}bg-emerald-500/15 border border-emerald-400/40 text-emerald-100{{else}}bg-rose-500/15 border border-rose-400/40 text-rose-100{{/if}}">
            {{#if connected}}В сети{{else}}Оффлайн{{/if}}
          </span>
        </div>
        <div class="mt-4 space-y-2 text-sm text-slate-300">
          <div class="flex items-center justify-between">
            <span class="text-slate-400">IP</span>
            <span id="ip_{{id}}" class="font-mono text-slate-100">{{ip}}</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-slate-400">MAC</span>
            <span id="mac{{id}}" class="font-mono text-slate-100">{{mac}}</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-slate-400">Производитель</span>
            <span id="vendor_{{id}}" class="text-slate-100">{{vendor}}</span>
          </div>
        </div>
        <div class="mt-4 flex flex-wrap items-center justify-between gap-2">
          <a href="#history-modal-{{id}}" class="history-btn modal-trigger inline-flex items-center gap-2 rounded-lg border border-border/80 px-3 py-2 text-xs font-semibold text-slate-100 transition hover:border-brand hover:bg-brand/10">
            <span class="material-icons text-base">timeline</span> История
          </a>
          <div class="flex flex-wrap gap-2">
            <button class="manage-device-ip inline-flex items-center gap-1 rounded-lg border border-border/80 px-3 py-2 text-xs font-semibold text-slate-100 transition hover:border-brand/60" data-ip="{{ip}}">
              <span class="material-icons text-base">content_copy</span> IP
            </button>
            <button class="manage-device inline-flex items-center gap-1 rounded-lg border border-brand/60 bg-brand/10 px-3 py-2 text-xs font-semibold text-brand shadow-glow transition hover:bg-brand/20" data-ip="{{ip}}">
              <span class="material-icons text-base">desktop_windows</span> Управление
            </button>
          </div>
        </div>
      </div>
    {{/each}}
  </div>

  {{#each devices}}
    <div id="history-modal-{{id}}" class="modal fixed inset-0 z-50 hidden modal-backdrop px-4 py-8">
      <div class="mx-auto flex h-full max-w-xl items-center justify-center">
        <div class="w-full rounded-2xl glass-panel border border-border/80 p-6 shadow-glow">
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-xs uppercase tracking-[0.2em] text-slate-400">история</p>
              <h4 class="mt-1 text-xl font-semibold text-slate-50">События {{name}}</h4>
            </div>
            <button class="modal-close h-9 w-9 rounded-lg border border-border/70 bg-white/5 text-slate-300 transition hover:text-white" aria-label="Закрыть">
              <span class="material-icons text-base">close</span>
            </button>
          </div>
          <ul class="mt-4 space-y-2" id="history-list-{{id}}">
            <li class="rounded-lg border border-border/70 bg-white/5 px-3 py-2 text-sm text-slate-400">Данных пока нет.</li>
          </ul>
        </div>
      </div>
    </div>
  {{/each}}

  <div class="glass-panel rounded-2xl border border-border/80 p-6 shadow-glow">
    <div class="flex flex-col gap-2">
      <p class="text-xs uppercase tracking-[0.2em] text-slate-400">аналитика</p>
      <h5 class="text-xl font-semibold text-slate-50">Производители</h5>
      <p class="text-sm text-slate-400">ТОП-поставщики по обнаруженным устройствам.</p>
    </div>
    <div class="mt-4 grid gap-4 lg:grid-cols-2">
      <div class="rounded-xl border border-border/70 bg-[#0b1120]/60 p-4">
        <div class="h-72">
          <canvas id="vendorChart"></canvas>
        </div>
      </div>
      <div class="overflow-hidden rounded-xl border border-border/70">
        <table class="min-w-full divide-y divide-border/70 text-sm text-slate-200">
          <thead class="bg-white/5 text-xs uppercase tracking-wide text-slate-400">
            <tr>
              <th class="px-4 py-3 text-left font-semibold">Производитель</th>
              <th class="px-4 py-3 text-left font-semibold">Кол-во</th>
              <th class="px-4 py-3 text-left font-semibold">Доля</th>
            </tr>
          </thead>
          <tbody id="vendorTableBody" class="divide-y divide-border/70 bg-[#0a101d]"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="/chart.js"></script>
<script>
  $(document).ready(() => {
    let ascendingOrder = true;
    let currentActivityRange = '24h';

    const ipToNum = ip => {
      if (typeof ip !== 'string') return 0;
      return ip.split('.').reduce((acc, octet) => acc * 256 + parseInt(octet, 10), 0);
    };

    const formatDate = date => {
      const d = new Date(date);
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      const hours = String(d.getHours()).padStart(2, '0');
      const minutes = String(d.getMinutes()).padStart(2, '0');
      const seconds = String(d.getSeconds()).padStart(2, '0');
      return `${day}.${month}.${year} ${hours}:${minutes}:${seconds}`;
    };

    const updateAnalytics = () => {
      const cards = $('.device-card:visible');
      const total = cards.length;
      let connected = 0, disconnected = 0;
      cards.each(function() {
        const isConnected = $(this).data('connected');
        if (isConnected === true || isConnected == "1") connected++;
        if (isConnected === false || isConnected == "0") disconnected++;
      });
      $('#total-devices').find('span:last').text(total);
      $('#connected-devices').find('span:last').text(connected);
      $('#disconnected-devices').find('span:last').text(disconnected);
      $('#last-update').find('span:last').text(formatDate(new Date()));
    };

    const sortDevices = (orderBy, ascending) => {
      const cards = $('.device-card').get();
      cards.sort((a, b) => {
        let aVal = $(a).data(orderBy);
        let bVal = $(b).data(orderBy);
        if (orderBy === 'ip') {
          aVal = ipToNum(aVal);
          bVal = ipToNum(bVal);
        } else if (orderBy === 'last_seen') {
          aVal = new Date(aVal).getTime();
          bVal = new Date(bVal).getTime();
        } else {
          if (!isNaN(aVal) && !isNaN(bVal)) {
            aVal = parseFloat(aVal);
            bVal = parseFloat(bVal);
          } else {
            aVal = (aVal || '').toString().toLowerCase();
            bVal = (bVal || '').toString().toLowerCase();
          }
        }
        if (aVal < bVal) return ascending ? -1 : 1;
        if (aVal > bVal) return ascending ? 1 : -1;
        return 0;
      });
      $('#devices-list').html(cards);
    };

    const applyFilters = () => {
      const searchText = $('#search').val().toLowerCase();
      const filterState = $('input[name="device_filter"]:checked').val();
      $('.device-card').each(function() {
        const card = $(this);
        const deviceText = card.text().toLowerCase();
        let show = deviceText.includes(searchText);
        const isConnected = card.data('connected');
        if (filterState === 'connected') show = show && (isConnected === true || isConnected == "1");
        else if (filterState === 'disconnected') show = show && (isConnected === false || isConnected == "0");
        card.toggle(show);
      });
      updateAnalytics();
      initExtendedAnalytics();
    };

    $('#sort-options').on('change', () => {
      const orderBy = $('#sort-options').val();
      sortDevices(orderBy, ascendingOrder);
    });

    $('#toggle-order').on('click', function(e) {
      e.preventDefault();
      ascendingOrder = !ascendingOrder;
      const orderBy = $('#sort-options').val();
      sortDevices(orderBy, ascendingOrder);
      $(this).text(`Сортировать: ${ascendingOrder ? 'по возрастанию' : 'по убыванию'}`);
    });

    $('#search').on('input', applyFilters);
    $('input[name="device_filter"]').on('change', applyFilters);

    $('#refresh-data').on('click', function(e) {
      e.preventDefault();
      showToast('Данные обновлены', 'success');
      applyFilters();
    });

    $('.modal-trigger').on('click', function() {
      const deviceId = $(this).attr('href').replace('#history-modal-', '');
      if (!deviceId) return;
      const historyList = $(`#history-list-${deviceId}`);
      $.get(`/device-history/${deviceId}`, history => {
        historyList.empty();
        if (!history.length) {
          historyList.html('<li class="rounded-lg border border-border/70 bg-white/5 px-3 py-2 text-sm text-slate-400">Пока без событий.</li>');
          return;
        }
        history.forEach(event => {
          historyList.append(`
            <li class="flex items-center justify-between rounded-lg border border-border/70 bg-white/5 px-3 py-2 text-sm text-slate-200">
              <div class="flex items-center gap-2">
                <span class="material-icons text-base">${getEventIcon(event.event_type)}</span>
                <span>${event.event_type}</span>
              </div>
              <span class="text-xs text-slate-400">${formatDate(event.event_time)}</span>
            </li>
          `);
        });
      }).fail(() => {
        historyList.html('<li class="rounded-lg border border-rose-400/40 bg-rose-500/10 px-3 py-2 text-sm text-rose-100">Не удалось загрузить историю</li>');
      });
    });

    $('.manage-device').on('click', function() {
      const ip = $(this).data('ip');
      openVNCViewer(ip);
    });
    $('.manage-device-ip').on('click', function() {
      const ip = $(this).data('ip');
      if (navigator.clipboard) {
        navigator.clipboard.writeText(ip)
          .then(() => showToast('IP скопирован', 'success'))
          .catch(err => console.error("Не удалось скопировать IP", err));
      }
    });

    const openVNCViewer = ip => {
      const vncUrl = `vnc://${ip}`;
      window.location.href = vncUrl;
      setTimeout(() => {
        if (document.visibilityState === 'visible') {
          showToast('VNC-протокол не поддерживается', 'error');
          if (navigator.clipboard) {
            navigator.clipboard.writeText(ip).catch(() => {});
          }
        }
      }, 1000);
    };

    const getEventIcon = eventType => {
      switch (eventType) {
        case 'connected': return 'check_circle';
        case 'disconnected': return 'cancel';
        case 'ip_changed': return 'swap_horiz';
        default: return 'info';
      }
    };

    updateAnalytics();

    const charts = {
      connection: initChart('connectionChart', 'doughnut'),
      vendor: initChart('vendorChart', 'bar'),
      activity: initChart('activityChart', 'line')
    };

    function initExtendedAnalytics() {
      updateConnectionChart();
      updateVendorStats();
      updateActivityChart(currentActivityRange);
      updateMetrics();
    }

    function initChart(canvasId, type) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      return new Chart(ctx, {
        type: type,
        data: {},
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { color: '#cbd5e1' } },
            tooltip: { enabled: true }
          },
          scales: {
            x: { ticks: { color: '#cbd5e1' }, grid: { color: '#1f2937' } },
            y: { ticks: { color: '#cbd5e1' }, grid: { color: '#1f2937' } }
          }
        }
      });
    }

    function updateConnectionChart() {
      const devices = getFilteredDevices();
      const connected = devices.filter(d => d.connected || d.connected === 1 || d.connected === "1").length;
      charts.connection.data = {
        labels: ['Онлайн', 'Оффлайн'],
        datasets: [{
          data: [connected, devices.length - connected],
          backgroundColor: ['#10b981', '#ef4444']
        }]
      };
      charts.connection.update();
    }

    function updateVendorStats() {
      const vendors = {};
      const devices = getFilteredDevices();
      devices.forEach(device => {
        if (device.vendor && device.vendor !== 'Unknown'){
          vendors[device.vendor] = (vendors[device.vendor] || 0) + 1;
        }
      });
      const sorted = Object.entries(vendors).sort((a, b) => b[1] - a[1]);
      const topVendors = sorted.slice(0, 5);
      charts.vendor.data = {
        labels: topVendors.map(v => v[0]),
        datasets: [{
          label: 'Устройства',
          data: topVendors.map(v => v[1]),
          backgroundColor: '#0b7db4'
        }]
      };
      charts.vendor.update();
      const total = devices.length || 1;
      $('#vendorTableBody').html(
        sorted.map(([vendor, count]) => `
          <tr>
            <td class="px-4 py-3">${vendor}</td>
            <td class="px-4 py-3">${count}</td>
            <td class="px-4 py-3">${((count / total) * 100).toFixed(1)}%</td>
          </tr>
        `).join('')
      );
    }

    function updateActivityChart(range) {
      let hours = 24;
      if (range === '7d') hours = 24 * 7;
      else if (range === '1h') hours = 1;
      else if (range === '6h') hours = 6;
      else if (range === '12h') hours = 12;
      else if (range === '30d') hours = 24 * 30;

      $.get(`/device-activ/${hours}`, activ => {
        const labels = [];
        const dataPointsConn = [];
        const dataPointsDisConn = [];
        activ.forEach(item => {
          labels.push(`${item.time_interval}`);
          dataPointsConn.push(parseInt(item.connects));
          dataPointsDisConn.push(parseInt(item.disconnects));
        });
        charts.activity.data = {
          labels: labels,
          datasets: [{
            label: 'Подключения',
            data: dataPointsConn,
            borderColor: '#0b7db4',
            tension: 0.4,
            fill: false
          },{
            label: 'Отключения',
            data: dataPointsDisConn,
            borderColor: '#ef4444',
            tension: 0.4,
            fill: false
          }]
        };
        charts.activity.update();
      });
    }

    $('.time-filter button').on('click', function() {
      $('.time-filter button').removeClass('bg-white/5 text-white');
      $(this).addClass('bg-white/5 text-white');
      currentActivityRange = $(this).data('range');
      updateActivityChart(currentActivityRange);
    });

    function updateMetrics() {
      const devices = getFilteredDevices();
      const avgActivity = devices.length > 0
        ? devices.reduce((sum, d) => sum + (d.connected ? 1 : 0), 0) / devices.length
        : 0;
      const $badge = $('.metric-badge');
      $badge.text(`В сети: ${(avgActivity * 100).toFixed(1)}%`);
    }

    function getFilteredDevices() {
      return Array.from(document.querySelectorAll('.device-card')).map(card => {
        try { return JSON.parse(card.dataset.device); } catch (e) { return {}; }
      });
    }

    $('#exportCSV').on('click', () => {
      const csvContent = convertToCSV(getFilteredDevices());
      if (!csvContent) return;
      downloadFile(csvContent, 'devices.csv');
      showToast('CSV сформирован', 'success');
    });

    function convertToCSV(data) {
      if (!data.length) return '';
      const headers = Object.keys(data[0]);
      return [
        headers.join(','),
        ...data.map(row => headers.map(field => JSON.stringify(row[field] ?? '')).join(','))
      ].join('\n');
    }

    function downloadFile(content, filename) {
      const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    }

    initExtendedAnalytics();
  });
</script>
